# Data Models - Main Web Application

*Generated as part of comprehensive project documentation*

## Database Overview

**Database Type:** PostgreSQL with Drizzle ORM
**Migration Tool:** Drizzle Kit
**Schema Pattern:** Multi-tenant organization-based architecture

This is a sophisticated project management and resource planning system with comprehensive database design supporting advanced resource scheduling, time tracking, and organizational management.

## Core Database Architecture

### Schema Organization

The database uses a **multi-tenant architecture** with organization-based data isolation:

- **Prefix:** All tables use `pg-drizzle_` prefix
- **Foreign Key Strategy:** Most relationships use `ON DELETE CASCADE` for referential integrity
- **Indexing:** Comprehensive indexing strategy with 50+ performance indexes
- **Time Zone Support:** Full UTC-based timestamp storage with time zone handling

### Database Files

- **Schema Definition:** `/src/server/db/schema.ts` - Complete Drizzle ORM schema
- **Migration:** `/drizzle/0000_absent_mephistopheles.sql` - Initial database migration
- **Configuration:** `/drizzle.config.ts` - Drizzle ORM configuration

## Data Model Categories

### 1. Authentication & User Management

#### `pg-drizzle_user` - User Accounts

**Purpose:** Core user identity and authentication
```sql
CREATE TABLE pg-drizzle_user (
    id text PRIMARY KEY,
    name text NOT NULL,
    email text NOT NULL UNIQUE,
    email_verified boolean NOT NULL DEFAULT false,
    image text,
    created_at timestamp NOT NULL DEFAULT now(),
    updated_at timestamp NOT NULL DEFAULT now()
);
```

**Key Features:**
- Email-based identity with verification
- Optional avatar support
- Full audit trail with timestamps
- Unique email constraint enforcement

#### `pg-drizzle_session` - User Sessions

**Purpose:** Secure session management with Better Auth
```sql
CREATE TABLE pg-drizzle_session (
    id text PRIMARY KEY,
    expires_at timestamp NOT NULL,
    token text NOT NULL UNIQUE,
    created_at timestamp NOT NULL DEFAULT now(),
    updated_at timestamp NOT NULL DEFAULT now(),
    ip_address text,
    user_agent text,
    user_id text NOT NULL REFERENCES pg-drizzle_user(id) ON DELETE CASCADE
);
```

**Key Features:**
- Secure token-based sessions
- IP and User Agent tracking
- Expiration management
- Automatic cleanup on user deletion

#### `pg-drizzle_account` - External Authentication Accounts

**Purpose:** Social login and external authentication providers
```sql
CREATE TABLE pg-drizzle_account (
    id text PRIMARY KEY,
    account_id text NOT NULL,
    provider_id text NOT NULL,
    user_id text NOT NULL REFERENCES pg-drizzle_user(id) ON DELETE CASCADE,
    access_token text,
    refresh_token text,
    id_token text,
    access_token_expires_at timestamp,
    refresh_token_expires_at timestamp,
    scope text,
    password text,
    created_at timestamp NOT NULL DEFAULT now(),
    updated_at timestamp NOT NULL DEFAULT now()
);
```

#### `pg-drizzle_verification` - Email Verification

**Purpose:** Email verification and one-time codes
```sql
CREATE TABLE pg-drizzle_verification (
    id text PRIMARY KEY,
    identifier text NOT NULL,
    value text NOT NULL,
    expires_at timestamp NOT NULL,
    created_at timestamp,
    updated_at timestamp
);
```

### 2. Organization Management

#### `pg-drizzle_organization` - Organizations

**Purpose:** Multi-tenant organization management
```sql
CREATE TABLE pg-drizzle_organization (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name varchar(256) NOT NULL,
    description text,
    slug varchar(100) NOT NULL UNIQUE,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

**Key Features:**
- Auto-generated primary keys
- Unique URL-friendly slugs
- Optional descriptions
- Time zone aware timestamps

#### `pg-drizzle_organization_member` - Organization Memberships

**Purpose:** User-organization relationships with roles
```sql
CREATE TABLE pg-drizzle_organization_member (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    organization_id integer NOT NULL REFERENCES pg-drizzle_organization(id) ON DELETE CASCADE,
    user_id text NOT NULL REFERENCES pg-drizzle_user(id) ON DELETE CASCADE,
    role varchar(50) NOT NULL DEFAULT 'member',
    joined_at timestamp with time zone NOT NULL DEFAULT now()
);
```

**Key Features:**
- Role-based access control (admin, member, etc.)
- Join tracking with timestamps
- Cascade deletion for data integrity

### 3. Project Management

#### `pg-drizzle_project` - Projects

**Purpose:** Project definition and lifecycle management
```sql
CREATE TABLE pg-drizzle_project (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    organization_id integer NOT NULL REFERENCES pg-drizzle_organization(id) ON DELETE CASCADE,
    name varchar(256) NOT NULL,
    description text,
    status varchar(50) NOT NULL DEFAULT 'planning',
    start_date date,
    end_date date,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

**Key Features:**
- Organization-based data isolation
- Project status tracking (planning, active, completed, etc.)
- Date range management
- Comprehensive audit trail

#### `pg-drizzle_task` - Work Breakdown Structure Tasks

**Purpose:** Hierarchical task management with advanced scheduling
```sql
CREATE TABLE pg-drizzle_task (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    project_id integer NOT NULL REFERENCES pg-drizzle_project(id) ON DELETE CASCADE,
    parent_id integer REFERENCES pg-drizzle_task(id) ON DELETE CASCADE,
    name varchar(256) NOT NULL,
    description text,
    wbs_code varchar(50),
    status varchar(50) NOT NULL DEFAULT 'not_started',
    progress integer DEFAULT 0,
    is_milestone boolean NOT NULL DEFAULT false,
    scheduled_type varchar(20) NOT NULL DEFAULT 'manual',
    planned_start_date date,
    planned_end_date date,
    actual_start_date date,
    actual_end_date date,
    duration integer,
    estimated_hours numeric(8,2),
    actual_hours numeric(8,2) DEFAULT 0,
    constraint_type varchar(20),
    constraint_date date,
    deadline date,
    priority integer DEFAULT 0,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

**Advanced Features:**
- **Hierarchical Structure:** Self-referencing parent_id for WBS
- **WBS Codes:** Work Breakdown Structure coding support
- **Progress Tracking:** Percentage completion with actual vs estimated
- **Milestone Management:** Special milestone task type
- **Constraint Management:** Start/finish constraints with dates
- **Priority System:** Numerical priority ordering
- **Duration Tracking:** Automatic duration calculation
- **Time Tracking:** Estimated vs actual hour comparison

#### `pg-drizzle_task_dependency` - Task Dependencies

**Purpose:** Critical Path Method (CPM) task relationships
```sql
CREATE TABLE pg-drizzle_task_dependency (
    predecessor_id integer NOT NULL REFERENCES pg-drizzle_task(id) ON DELETE CASCADE,
    successor_id integer NOT NULL REFERENCES pg-drizzle_task(id) ON DELETE CASCADE,
    dependency_type varchar(20) NOT NULL DEFAULT 'fs',
    lag integer DEFAULT 0,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    PRIMARY KEY (predecessor_id, successor_id)
);
```

**Dependency Types:**
- **FS (Finish-to-Start):** Predecessor must finish before successor starts (default)
- **SS (Start-to-Start):** Predecessor must start before successor starts
- **FF (Finish-to-Finish):** Predecessor must finish before successor finishes
- **SF (Start-to-Finish):** Predecessor must start before successor finishes

### 4. Resource Management

#### `pg-drizzle_resource` - Resources

**Purpose:** Comprehensive resource management (human, equipment, facilities)
```sql
CREATE TABLE pg-drizzle_resource (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    organization_id integer NOT NULL REFERENCES pg-drizzle_organization(id) ON DELETE CASCADE,
    user_id text REFERENCES pg-drizzle_user(id) ON DELETE SET NULL,
    name varchar(256) NOT NULL,
    type varchar(50) NOT NULL DEFAULT 'human',
    hourly_rate numeric(10,2),
    daily_work_hours numeric(4,2) DEFAULT 8,
    currency varchar(3) DEFAULT 'USD',
    is_active boolean NOT NULL DEFAULT true,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

**Key Features:**
- **Multi-type Resources:** Human, equipment, facilities, etc.
- **Currency Support:** Multi-currency hourly rates
- **Work Hour Profiles:** Customizable daily work hours
- **User Linking:** Optional link to user accounts
- **Active Status:** Enable/disable resources without deletion

#### `pg-drizzle_resource_work_schedule` - Work Schedules

**Purpose:** Detailed work schedules with day-type-specific configurations
```sql
CREATE TABLE pg-drizzle_resource_work_schedule (
    resource_id integer NOT NULL REFERENCES pg-drizzle_resource(id) ON DELETE CASCADE,
    day_of_week integer NOT NULL, -- 0-6 (Sunday-Saturday)
    day_type varchar(20) NOT NULL DEFAULT 'regular',
    is_working_day boolean NOT NULL DEFAULT true,
    work_start_time time,
    work_end_time time,
    break_start_time time,
    break_end_time time,
    total_work_hours numeric(4,2),
    hourly_rate numeric(10,2),
    currency varchar(3) DEFAULT 'USD',
    is_active boolean NOT NULL DEFAULT true,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone,
    PRIMARY KEY (resource_id, day_of_week)
);
```

**Advanced Features:**
- **Day-of-Week Schedules:** Individual schedules for each day
- **Day Types:** Regular, overtime, holiday, weekend classifications
- **Flexible Hours:** Custom work hours with break periods
- **Dynamic Rates:** Day-specific hourly rates
- **Time Zone Support:** Resource-specific time zones

#### `pg-drizzle_resource_availability` - Resource Availability

**Purpose:** Resource availability tracking with recurring patterns
```sql
CREATE TABLE pg-drizzle_resource_availability (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    resource_id integer NOT NULL REFERENCES pg-drizzle_resource(id) ON DELETE CASCADE,
    start_date date NOT NULL,
    end_date date NOT NULL,
    availability_type varchar(20) NOT NULL, -- 'available', 'unavailable', 'partial'
    description text,
    is_full_day boolean NOT NULL DEFAULT true,
    start_time time,
    end_time time,
    is_recurring boolean NOT NULL DEFAULT false,
    recurring_pattern varchar(50), -- 'daily', 'weekly', 'monthly'
    recurring_end_date date,
    time_zone varchar(50),
    is_active boolean NOT NULL DEFAULT true,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

**Availability Types:**
- **Available:** Resource is available for work
- **Unavailable:** Resource is unavailable (vacation, maintenance)
- **Partial:** Resource is available for limited hours

#### `pg-drizzle_resource_time_zone` - Time Zone Management

**Purpose:** Resource time zone configuration for global scheduling
```sql
CREATE TABLE pg-drizzle_resource_time_zone (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    resource_id integer NOT NULL REFERENCES pg-drizzle_resource(id) ON DELETE CASCADE,
    time_zone varchar(50) NOT NULL,
    utc_offset varchar(6),
    is_dst boolean NOT NULL DEFAULT false,
    is_active boolean NOT NULL DEFAULT true,
    effective_date date NOT NULL DEFAULT now(),
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

#### `pg-drizzle_resource_day_type_rate` - Dynamic Pricing

**Purpose:** Day-type-specific hourly rates with temporal effectiveness
```sql
CREATE TABLE pg-drizzle_resource_day_type_rate (
    resource_id integer NOT NULL REFERENCES pg-drizzle_resource(id) ON DELETE CASCADE,
    day_type varchar(20) NOT NULL,
    base_hourly_rate numeric(10,2) NOT NULL,
    overtime_multiplier numeric(4,2) DEFAULT 1.5,
    currency varchar(3) DEFAULT 'USD',
    minimum_hours numeric(4,2) DEFAULT 0,
    maximum_hours numeric(4,2),
    effective_date date NOT NULL DEFAULT now(),
    expiry_date date,
    is_active boolean NOT NULL DEFAULT true,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone,
    PRIMARY KEY (resource_id, day_type, effective_date)
);
```

**Key Features:**
- **Temporal Rates:** Time-based rate changes
- **Overtime Multipliers:** Automatic overtime rate calculation
- **Hour Limits:** Minimum and maximum work hour constraints
- **Rate History:** Historical rate tracking

### 5. Resource Assignment & Scheduling

#### `pg-drizzle_resource_assignment` - Task Assignments

**Purpose:** Resource-to-task assignments with detailed parameters
```sql
CREATE TABLE pg-drizzle_resource_assignment (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    task_id integer NOT NULL REFERENCES pg-drizzle_task(id) ON DELETE CASCADE,
    resource_id integer NOT NULL REFERENCES pg-drizzle_resource(id) ON DELETE CASCADE,
    assigned_units numeric(4,2) DEFAULT 1,
    assigned_hours numeric(8,2),
    cost numeric(10,2),
    start_date date,
    end_date date,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

**Key Features:**
- **Fractional Assignments:** Partial resource allocation
- **Cost Calculation:** Automatic cost computation
- **Date Range Assignment:** Time-bound resource allocation
- **Unit-Based:** Supports equipment units and FTE calculations

### 6. Time Tracking

#### `pg-drizzle_time_entry` - Time Logging

**Purpose:** Detailed time tracking with day-type classification
```sql
CREATE TABLE pg-drizzle_time_entry (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    task_id integer NOT NULL REFERENCES pg-drizzle_task(id) ON DELETE CASCADE,
    resource_id integer NOT NULL REFERENCES pg-drizzle_resource(id) ON DELETE CASCADE,
    user_id text NOT NULL REFERENCES pg-drizzle_user(id) ON DELETE CASCADE,
    date date NOT NULL,
    start_time time,
    end_time time,
    hours numeric(4,2) NOT NULL,
    day_type varchar(20) NOT NULL DEFAULT 'regular',
    hourly_rate numeric(10,2),
    cost numeric(10,2),
    time_zone varchar(50),
    is_overtime boolean NOT NULL DEFAULT false,
    description text,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

**Advanced Features:**
- **Day Type Classification:** Regular, overtime, holiday categorization
- **Time Zone Support:** Global time tracking
- **Rate Application:** Automatic cost calculation
- **Overtime Detection:** Built-in overtime flagging

### 7. Baseline Management

#### `pg-drizzle_baseline` - Project Baselines

**Purpose:** Project planning baseline snapshots
```sql
CREATE TABLE pg-drizzle_baseline (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    project_id integer NOT NULL REFERENCES pg-drizzle_project(id) ON DELETE CASCADE,
    name varchar(256) NOT NULL,
    description text,
    created_at timestamp with time zone NOT NULL DEFAULT now()
);
```

#### `pg-drizzle_baseline_task` - Baseline Tasks

**Purpose:** Historical task snapshots for baseline comparison
```sql
CREATE TABLE pg-drizzle_baseline_task (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    baseline_id integer NOT NULL REFERENCES pg-drizzle_baseline(id) ON DELETE CASCADE,
    task_id integer NOT NULL REFERENCES pg-drizzle_task(id) ON DELETE CASCADE,
    name varchar(256) NOT NULL,
    description text,
    planned_start_date date,
    planned_end_date date,
    estimated_hours numeric(8,2),
    progress integer DEFAULT 0,
    is_milestone boolean NOT NULL DEFAULT false
);
```

### 8. Content Management

#### `pg-drizzle_post` - Content Posts

**Purpose:** Simple content management for documentation and announcements
```sql
CREATE TABLE pg-drizzle_post (
    id integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name varchar(256),
    created_by_id varchar(255) NOT NULL REFERENCES pg-drizzle_user(id) ON DELETE CASCADE,
    created_at timestamp with time zone NOT NULL DEFAULT now(),
    updated_at timestamp with time zone
);
```

## Database Relationships

### Primary Relationship Flow

```
Organization (1) → (N) Projects (1) → (N) Tasks (1) → (N) Time Entries
Organization (1) → (N) Resources (1) → (N) Work Schedules
Organization (1) → (N) Resources (1) → (N) Availability Records
User (1) → (N) Sessions
User (1) → (N) Organization Memberships
User (1) → (N) Time Entries
Task (1) → (N) Task Dependencies (Self-reference)
Task (1) → (N) Resource Assignments
Task (1) → (N) Baseline Tasks
Resource (1) → (N) Resource Assignments
Resource (1) → (N) Time Entries
```

### Key Design Patterns

**1. Soft Deletion Pattern:**
- `is_active` flags instead of hard deletes
- Preserves historical data and relationships

**2. Audit Trail Pattern:**
- `created_at` and `updated_at` timestamps on all tables
- Comprehensive change tracking

**3. Multi-Tenancy Pattern:**
- Organization-based data isolation
- Foreign key constraints enforce data boundaries

**4. Temporal Data Pattern:**
- Time zone aware timestamps
- Effective date ranges for rate changes
- Historical data preservation

## Performance Considerations

### Indexing Strategy

The database includes **50+ performance indexes** covering:

- **Foreign Key Indexes:** All relationships are indexed
- **Status Indexes:** Query optimization for status-based filtering
- **Date Range Indexes:** Efficient availability and assignment queries
- **Search Indexes:** Name and description field searches
- **Composite Indexes:** Multi-column query optimization

### Query Patterns

**Common Query Types:**
1. **Resource Scheduling:** JOIN tasks, assignments, availability
2. **Time Tracking:** Aggregated hours by resource and date
3. **Project Progress:** Task completion and milestone tracking
4. **Organization Reports:** Multi-tenant data aggregation

### Scalability Features

- **Partitioning:** Time-based partitioning potential for time entries
- **Archiving:** Baseline system supports historical data archiving
- **Caching:** Application-level caching for frequently accessed data

## Data Integrity

### Constraints

**Primary Keys:** All tables have properly defined primary keys
**Foreign Keys:** Comprehensive referential integrity with cascade rules
**Unique Constraints:** Email, slugs, tokens, and composite keys
**Check Constraints:** Status fields, priority ranges, percentage limits

### Cascade Rules

- **ON DELETE CASCADE:** Most relationships cascade to maintain data consistency
- **ON DELETE SET NULL:** User references in resources to preserve resource data

---

*This database schema represents a production-ready, enterprise-grade project management and resource planning system with advanced scheduling, time tracking, and multi-tenant capabilities.*